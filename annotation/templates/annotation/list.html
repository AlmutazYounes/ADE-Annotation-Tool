{% extends 'annotation/base.html' %}

{% block title %}
{% if annotation %}Annotation #{{ annotation.id }}{% else %}Medical Text Annotation{% endif %}
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-3">
{% if no_annotations %}
    <!-- Modern Empty State -->
    <div class="row justify-content-center">
        <div class="col-lg-6">
            <div class="card text-center py-5">
                <div class="p-4">
                    <div class="mb-4">
                        <i class="fas fa-file-medical fa-4x text-muted opacity-50"></i>
                    </div>
                    <h3 class="fw-bold text-gray-800 mb-3">No Annotations Available</h3>
                    <p class="text-muted mb-4 fs-5">Start by importing your medical text data to begin the annotation process.</p>
                    <a href="{% url 'import_jsonl' %}" class="btn btn-primary btn-lg">
                        <i class="fas fa-cloud-upload-alt"></i>
                        Import Medical Data
                    </a>
                </div>
            </div>
        </div>
    </div>
{% else %}
    <!-- Compact Statistics & Navigation Bar -->
    <div class="stats-modern-compact mb-2">
        <div class="row g-2 align-items-center">
            <div class="col-md-2">
                <div class="d-flex gap-1">
                    <div class="stats-pill-compact validated flex-fill text-center">
                        <div class="fw-bold">{{ validated_count }}</div>
                        <div class="tiny">Valid</div>
                    </div>
                    <div class="stats-pill-compact pending flex-fill text-center">
                        <div class="fw-bold">{{ unvalidated_count }}</div>
                        <div class="tiny">Pending</div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="text-center">
                    <h6 class="fw-bold text-primary mb-0">
                        <i class="fas fa-file-medical text-primary"></i>
                        Annotation #{{ annotation.id }}
                    </h6>
                    <small class="text-muted">
                        {% if annotation.is_validated %}
                            <i class="fas fa-check-circle text-success"></i> Validated
                        {% else %}
                            <i class="fas fa-clock text-warning"></i> Pending
                        {% endif %}
                    </small>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="d-flex gap-2 align-items-center">
                    {% if prev_annotation %}
                        <a href="{% url 'annotation_single' prev_annotation.id %}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    {% else %}
                        <button class="btn btn-outline-primary btn-sm" disabled>
                            <i class="fas fa-chevron-left"></i>
                        </button>
                    {% endif %}
                    
                    <input type="range" 
                           class="form-range annotation-slider flex-grow-1" 
                           id="annotation-slider"
                           min="1" 
                           max="{{ total_count }}" 
                           value="{{ current_position }}"
                           onchange="jumpToAnnotation(this.value)"
                           oninput="updateSliderLabel(this.value)">
                    
                    <input type="number" 
                           min="1" 
                           max="{{ total_count }}" 
                           id="note-jump-input" 
                           class="form-control form-control-modern text-center note-input-wider" 
                           value="{{ current_position }}"
                           onkeydown="if(event.key==='Enter'){jumpToNoteInput();}">
                    
                    {% if next_annotation %}
                        <a href="{% url 'annotation_single' next_annotation.id %}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    {% else %}
                        <button class="btn btn-outline-primary btn-sm" disabled>
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    {% endif %}
                </div>
                <div class="text-center mt-1">
                    <small class="text-muted">
                        <span id="slider-preview">{{ current_position }} of {{ total_count }}</span>
                    </small>
                </div>
            </div>
            
            <div class="col-md-3 text-end">
                {% if next_annotation %}
                    <button class="btn btn-modern btn-success complete-btn-prominent" id="next-btn" onclick="validateAndNext()">
                        <i class="fas fa-check"></i>
                        Complete & Next
                    </button>
                {% else %}
                    <button class="btn btn-modern btn-success complete-btn-prominent" onclick="validateCurrent()">
                        <i class="fas fa-check"></i>
                        Complete
                    </button>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Intelligent Suggestions Bar - Fixed Height to Prevent Layout Shifts -->
    <div class="suggestions-container mb-2">
        <div id="quick-suggestions" class="alert-modern alert-info suggestions-fixed-height">
            <div class="d-flex align-items-center gap-3">
                <div class="flex-shrink-0">
                    <i class="fas fa-lightbulb"></i>
                    <strong class="fw-semibold ms-2">Smart Suggestions:</strong>
                </div>
                <div class="flex-grow-1">
                    <div id="suggestion-list">
                        {% if quick_drug_suggestions or quick_ade_suggestions %}
                            {% for drug in quick_drug_suggestions %}
                                <button type="button" class="btn btn-modern btn-success btn-sm me-1 mb-1" onclick="quickAddEntity('{{ drug }}', 'drug')">
                                    <i class="fas fa-pills"></i> {{ drug }}
                                </button>
                            {% endfor %}
                            {% for ade in quick_ade_suggestions %}
                                <button type="button" class="btn btn-modern btn-danger btn-sm me-1 mb-1" onclick="quickAddEntity('{{ ade }}', 'ade')">
                                    <i class="fas fa-exclamation-triangle"></i> {{ ade }}
                                </button>
                            {% endfor %}
                        {% else %}
                            <span class="text-muted small">None</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Annotation Interface - No Scroll Design -->
    <div class="row g-3">
        <!-- Text Display - Fixed Height, Scrollable -->
        <div class="col-lg-8">
            <div class="card clinical-text-card">
                <div class="card-header border-bottom px-3 py-2">
                    <div class="d-flex align-items-center justify-content-between">
                        <h6 class="fw-semibold mb-0">
                            <i class="fas fa-file-alt text-primary"></i>
                            Clinical Text
                        </h6>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-secondary" onclick="copyText()" title="Copy text to clipboard">
                                <i class="fas fa-copy" id="copy-icon"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="toggleFullscreen()">
                                <i class="fas fa-expand" id="fullscreen-icon"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="text-display-container" id="text-container">
                                    <div class="text-display" id="text-display" data-annotation-id="{{ annotation.id }}" data-original-text="{{ annotation.text }}">
                    {{ annotation.text }}
                </div>
                </div>
            </div>
        </div>
        
        <!-- Compact Annotation Sidebar -->
        <div class="col-lg-4">
            <div class="annotation-sidebar-compact">
                <form id="annotation-form">
                    {% csrf_token %}
                    
                    <!-- Drugs Section -->
                    <div class="entity-section mb-4">
                        <div class="entity-header">
                            <h6 class="fw-bold mb-2">
                                <i class="fas fa-pills text-success"></i>
                                Drugs
                                <span class="badge bg-success-subtle text-success-emphasis ms-2" id="drug-count">{{ annotation.drugs|length }}</span>
                            </h6>
                            <div class="input-group input-group-sm">
                                <input type="text" 
                                       class="form-control form-control-modern" 
                                       id="new-drug" 
                                       placeholder="Enter drug name..." 
                                       onkeypress="handleEnterKey(event, 'drugs')">
                                <button type="button" class="btn btn-modern btn-success btn-sm" onclick="addEntity('drugs')">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="entity-tags-container" id="current-drugs">
                            {% if annotation.drugs %}
                                {% for drug in annotation.drugs %}
                                    <span class="entity-tag-compact drug-tag" onclick="removeEntity('drugs', '{{ drug|escapejs }}')">
                                        {{ drug }}
                                        <i class="fas fa-times"></i>
                                    </span>
                                {% endfor %}
                            {% else %}
                                <div class="empty-state-compact">
                                    <i class="fas fa-pills opacity-50"></i>
                                    <span class="small">No drugs identified</span>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Adverse Events Section -->
                    <div class="entity-section mb-4">
                        <div class="entity-header">
                            <h6 class="fw-bold mb-2">
                                <i class="fas fa-exclamation-triangle text-danger"></i>
                                Adverse Events
                                <span class="badge bg-danger-subtle text-danger-emphasis ms-2" id="event-count">{{ annotation.adverse_events|length }}</span>
                            </h6>
                            <div class="input-group input-group-sm">
                                <input type="text" 
                                       class="form-control form-control-modern" 
                                       id="new-event" 
                                       placeholder="Enter adverse event..." 
                                       onkeypress="handleEnterKey(event, 'adverse_events')">
                                <button type="button" class="btn btn-modern btn-danger btn-sm" onclick="addEntity('adverse_events')">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="entity-tags-container" id="current-events">
                            {% if annotation.adverse_events %}
                                {% for event in annotation.adverse_events %}
                                    <span class="entity-tag-compact adverse-event-tag" onclick="removeEntity('adverse_events', '{{ event|escapejs }}')">
                                        {{ event }}
                                        <i class="fas fa-times"></i>
                                    </span>
                                {% endfor %}
                            {% else %}
                                <div class="empty-state-compact">
                                    <i class="fas fa-exclamation-triangle opacity-50"></i>
                                    <span class="small">No adverse events identified</span>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                                         <!-- Quick Reference -->
                     <div class="border-top pt-3">
                         <div class="small text-muted">
                             <div class="mb-1">
                                 <kbd class="bg-light text-dark border">Ctrl+Enter</kbd> Complete & Next
                             </div>
                             <div class="mb-1">
                                 <kbd class="bg-light text-dark border">Esc</kbd> Close popups
                             </div>
                             <div class="mb-1">
                                 <i class="fas fa-info-circle"></i> Select text to add entities
                             </div>
                             <div class="text-info">
                                 <i class="fas fa-lightbulb"></i> You can select individual words within highlighted entities
                             </div>
                         </div>
                     </div>
                </form>
            </div>
        </div>
    </div>
{% endif %}

<!-- Modern Text Selection Popup -->
<div id="selection-popup" class="selection-popup" style="display: none;">
    <div class="popup-content">
        <div class="fw-semibold text-gray-800 mb-3">
            Add "<span id="selected-text" class="text-primary"></span>" as:
        </div>
        <div class="popup-buttons">
            <button class="btn btn-success btn-sm" onclick="addSelectedEntity('drugs')">
                <i class="fas fa-pills"></i> Drug
            </button>
            <button class="btn btn-danger btn-sm" onclick="addSelectedEntity('adverse_events')">
                <i class="fas fa-exclamation-triangle"></i> Adverse Event
            </button>
            <button class="btn btn-outline-secondary btn-sm" onclick="searchGoogleSelectedText()">
                <i class="fab fa-google"></i> Search
            </button>
            <button class="btn btn-outline-secondary btn-sm" onclick="hideSelectionPopup()">
                <i class="fas fa-times"></i> Cancel
            </button>
        </div>
    </div>
</div>

<!-- Modern Entity Click Popup -->
<div id="entity-popup" class="selection-popup" style="display: none;">
    <div class="popup-content">
        <div class="fw-semibold text-gray-800 mb-3">
            <span id="entity-type-label"></span>: "<span id="entity-text" class="text-primary"></span>"
        </div>
        <div class="popup-buttons">
            <button class="btn btn-modern btn-danger btn-sm" onclick="removeSelectedEntity()">
                <i class="fas fa-trash"></i> Remove
            </button>
            <button class="btn btn-modern btn-outline-secondary btn-sm" onclick="hideEntityPopup()">
                <i class="fas fa-times"></i> Cancel
            </button>
        </div>
    </div>
</div>
</div>

<style>
/* Compact Top Section Styles */
.stats-modern-compact {
    background: white;
    border-radius: var(--radius-lg);
    padding: var(--space-sm) var(--space-md);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--gray-200);
    position: relative;
    z-index: 1;
}

.stats-pill-compact {
    background: var(--gray-100);
    border-radius: var(--radius-md);
    padding: var(--space-xs) var(--space-sm);
    font-size: 0.875rem;
    font-weight: 600;
    text-align: center;
    border: 1px solid var(--gray-200);
    min-height: 45px;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.stats-pill-compact.validated {
    background: linear-gradient(135deg, var(--success-100) 0%, var(--success-50) 100%);
    color: var(--success-700);
    border-color: var(--success-200);
}

.stats-pill-compact.pending {
    background: linear-gradient(135deg, var(--primary-100) 0%, var(--primary-50) 100%);
    color: var(--primary-700);
    border-color: var(--primary-200);
}

.tiny {
    font-size: 0.7rem;
    line-height: 1;
}

/* Wider Note Input */
.note-input-wider {
    width: 80px !important;
    font-size: 0.875rem;
    font-weight: 600;
    padding: var(--space-xs) var(--space-sm);
}

/* Prominent Complete Button */
.complete-btn-prominent {
    padding: var(--space-sm) var(--space-lg);
    font-size: 0.95rem;
    font-weight: 700;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md);
    text-transform: uppercase;
    letter-spacing: 0.025em;
}

.complete-btn-prominent:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

/* Selection Popup Styles */
.selection-popup {
    position: fixed;
    z-index: 9999;
    background: white;
    border-radius: 16px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    border: 1px solid var(--gray-200);
    min-width: 280px;
    max-width: 400px;
    backdrop-filter: blur(10px);
}

.popup-content {
    padding: 1.5rem;
}

.popup-content .fw-semibold {
    font-weight: 600;
    color: var(--primary-700);
    margin-bottom: 1rem;
    font-size: 1rem;
    line-height: 1.4;
}

.popup-content .text-primary {
    color: var(--primary-600);
    font-weight: 700;
}

.popup-buttons {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.75rem;
    margin-top: 1.25rem;
}

.popup-buttons .btn {
    padding: 0.75rem 1rem;
    font-size: 0.9rem;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    font-weight: 600;
    text-decoration: none;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: none;
}

.popup-buttons .btn-success {
    background: linear-gradient(135deg, var(--medical-drug), var(--medical-drug-dark));
    color: white;
}

.popup-buttons .btn-danger {
    background: linear-gradient(135deg, var(--medical-ade), var(--medical-ade-dark));
    color: white;
}

.popup-buttons .btn-outline-secondary {
    background: linear-gradient(135deg, var(--gray-100), var(--gray-200));
    color: var(--gray-700);
    border: 1px solid var(--gray-300);
}

.popup-buttons .btn-modern {
    background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
    color: white;
    border: none;
}

/* Fixed Height Suggestions - Prevents Layout Shifts */
.suggestions-container {
    height: 80px;
    margin-bottom: var(--space-md);
}

.suggestions-fixed-height {
    height: 70px;
    padding: var(--space-sm) var(--space-md);
    transition: opacity 0.3s ease;
    display: flex;
    align-items: center;
    overflow: hidden;
}

.suggestions-fixed-height .fas.fa-lightbulb {
    font-size: 1rem;
}

.suggestions-fixed-height #suggestion-list {
    max-height: 50px;
    overflow-y: auto;
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: var(--space-xs);
}

/* Compact Layout Styles */
.text-display-container {
    height: 70vh;
    overflow-y: auto;
    border-radius: 0 0 var(--radius-xl) var(--radius-xl);
    background: white;
    border: 1px solid var(--gray-200);
    box-shadow: var(--shadow-sm);
}

.text-display {
    height: auto;
    min-height: 100%;
    margin-bottom: 0;
    border-radius: 0;
    box-shadow: none;
    border: none;
    padding: var(--space-lg);
    line-height: 1.8;
    font-size: 1rem;
    color: var(--gray-800);
    text-align: justify;
    word-wrap: break-word;
    hyphens: auto;
}

.annotation-sidebar-compact {
    background: white;
    border-radius: var(--radius-xl);
    padding: var(--space-lg);
    box-shadow: var(--shadow-lg);
    border: 1px solid var(--gray-200);
    height: 70vh;
    overflow-y: auto;
}

.entity-section {
    background: var(--gray-50);
    border-radius: var(--radius-lg);
    padding: var(--space-md);
    border: 1px solid var(--gray-200);
}

.entity-header h6 {
    margin-bottom: var(--space-sm);
}

.entity-tags-container {
    max-height: 120px;
    overflow-y: auto;
    min-height: 60px;
    padding: var(--space-sm);
    background: white;
    border-radius: var(--radius-md);
    border: 1px solid var(--gray-200);
}

.entity-tag-compact {
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-xs) var(--space-sm);
    margin: 2px;
    border-radius: var(--radius-md);
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    transition: none;
    border: 1px solid;
    text-decoration: none;
}

.entity-tag-compact.drug-tag {
    background: linear-gradient(135deg, var(--medical-drug-light) 0%, var(--medical-drug) 100%);
    color: white;
    border-color: var(--medical-drug);
}

.entity-tag-compact.adverse-event-tag {
    background: linear-gradient(135deg, var(--medical-ade-light) 0%, var(--medical-ade) 100%);
    color: white;
    border-color: var(--medical-ade);
}

/* Text Highlighting Styles */
.highlight-drug {
    background: linear-gradient(135deg, var(--medical-drug-light) 0%, var(--medical-drug) 100%);
    color: white;
    padding: 2px 4px;
    border-radius: 4px;
    font-weight: 600;
    cursor: pointer;
    transition: none !important;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

/* Removed hover effect for highlight-drug */

.highlight-adverse-event {
    background: linear-gradient(135deg, var(--medical-ade-light) 0%, var(--medical-ade) 100%);
    color: white;
    padding: 2px 4px;
    border-radius: 4px;
    font-weight: 600;
    cursor: pointer;
    transition: none !important;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

/* Removed hover effect for highlight-adverse-event */

.empty-state-compact {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-sm);
    color: var(--gray-500);
    min-height: 40px;
    font-style: italic;
}

.card-header {
    background: var(--gray-50) !important;
    border-bottom: 1px solid var(--gray-200) !important;
}



/* Remove hover effect from clinical text card */
.clinical-text-card {
    transition: none !important;
}

.clinical-text-card:hover {
    box-shadow: var(--shadow-sm) !important;
    transform: none !important;
    border-color: var(--gray-200) !important;
}

/* Fullscreen mode */
.fullscreen-mode .text-display-container {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1050;
    height: 100vh;
    background: white;
    border-radius: 0;
}

.fullscreen-mode .text-display {
    padding: var(--space-2xl);
    font-size: 1.25rem;
    line-height: 1.8;
}

/* Responsive adjustments */
@media (max-width: 991px) {
    .text-display-container {
        height: 55vh;
    }
    
    .text-display {
        padding: var(--space-md);
        font-size: 0.95rem;
    }
    
    .annotation-sidebar-compact {
        height: 55vh;
        margin-top: var(--space-md);
    }
    
    .complete-btn-prominent {
        padding: var(--space-xs) var(--space-md);
        font-size: 0.875rem;
    }
}

@media (max-width: 767px) {
    .stats-modern-compact .row {
        text-align: center;
        flex-direction: column;
        gap: var(--space-sm);
    }
    
    .stats-modern-compact .col-md-4 .d-flex {
        flex-wrap: wrap;
        gap: var(--space-sm);
        justify-content: center;
    }
    
    .annotation-slider {
        order: 3;
        width: 100%;
        margin: var(--space-sm) 0;
    }
    
    .complete-btn-prominent {
        width: 100%;
        margin-top: var(--space-sm);
    }
    
    .note-input-wider {
        width: 70px !important;
    }
    
    .suggestions-container {
        height: 80px;
    }
    
    .suggestions-fixed-height {
        height: 70px;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Current data
let currentDrugs = {{ annotation.drugs|default:"[]"|safe }};
let currentEvents = {{ annotation.adverse_events|default:"[]"|safe }};
let selectedText = '';
let selectedEntity = '';
let isFullscreen = false;
let selectedTextPosition = null; // Store position of selected text

// Decode HTML entities
function decodeHtmlEntities(text) {
    const textarea = document.createElement('textarea');
    textarea.innerHTML = text;
    return textarea.value;
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Ensure original text is properly stored and escaped
    const textDisplay = document.getElementById('text-display');
    if (textDisplay) {
        const originalText = textDisplay.getAttribute('data-original-text') || textDisplay.textContent || textDisplay.innerText;
        // Store the original text without HTML entities
        textDisplay.setAttribute('data-original-text', originalText);
    }
    
    highlightEntities();
    setupTextSelection();
    setupGoogleSearchSelection();
});

// Copy text to clipboard
function copyText() {
    const textDisplay = document.getElementById('text-display');
    const copyIcon = document.getElementById('copy-icon');
    
    if (textDisplay) {
        const text = textDisplay.textContent || textDisplay.innerText;
        
        // Use the modern clipboard API
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(text).then(() => {
                // Show success feedback
                copyIcon.className = 'fas fa-check';
                copyIcon.style.color = '#28a745';
                
                setTimeout(() => {
                    copyIcon.className = 'fas fa-copy';
                    copyIcon.style.color = '';
                }, 1500);
            }).catch(err => {
                console.error('Failed to copy text: ', err);
                fallbackCopyTextToClipboard(text, copyIcon);
            });
        } else {
            // Fallback for older browsers
            fallbackCopyTextToClipboard(text, copyIcon);
        }
    }
}

// Fallback copy function for older browsers
function fallbackCopyTextToClipboard(text, copyIcon) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        const successful = document.execCommand('copy');
        if (successful) {
            // Show success feedback
            copyIcon.className = 'fas fa-check';
            copyIcon.style.color = '#28a745';
            
            setTimeout(() => {
                copyIcon.className = 'fas fa-copy';
                copyIcon.style.color = '';
            }, 1500);
        }
    } catch (err) {
        console.error('Fallback copy failed: ', err);
        alert('Failed to copy text to clipboard');
    }
    
    document.body.removeChild(textArea);
}

// Fullscreen toggle
function toggleFullscreen() {
    isFullscreen = !isFullscreen;
    const container = document.getElementById('text-container');
    const icon = document.getElementById('fullscreen-icon');
    
    if (isFullscreen) {
        container.classList.add('fullscreen-mode');
        icon.className = 'fas fa-compress';
        // Add escape key listener
        document.addEventListener('keydown', escapeFullscreen);
    } else {
        container.classList.remove('fullscreen-mode');
        icon.className = 'fas fa-expand';
        document.removeEventListener('keydown', escapeFullscreen);
    }
}

function escapeFullscreen(e) {
    if (e.key === 'Escape' && isFullscreen) {
        toggleFullscreen();
    }
}

// Slider navigation functions
function jumpToAnnotation(position) {
    const annotationIds = {{ all_annotation_ids|safe }};
    const targetId = annotationIds[position - 1];
    
    if (targetId) {
        window.location.href = `/annotation/${targetId}/`;
    }
}

function updateSliderLabel(position) {
    document.getElementById('slider-preview').textContent = `${position} of {{ total_count }}`;
    document.getElementById('note-jump-input').value = position;
}

// Setup text selection with support for selecting within highlighted entities
function setupTextSelection() {
    const textDisplay = document.getElementById('text-display');
    if (!textDisplay) return;
    
    textDisplay.addEventListener('mouseup', function(e) {
        setTimeout(() => {
            const selection = window.getSelection();
            const selected = selection.toString().trim();
            
            if (selected && selected.length > 0) {
                // Check if selection is within a highlighted entity
                const range = selection.getRangeAt(0);
                const container = range.commonAncestorContainer;
                const highlightedParent = container.nodeType === Node.TEXT_NODE 
                    ? container.parentElement 
                    : container;
                
                // If selection is within a highlighted entity, allow it
                if (highlightedParent && 
                    (highlightedParent.classList.contains('highlight-drug') || 
                     highlightedParent.classList.contains('highlight-adverse-event'))) {
                    selectedText = selected;
                    showSelectionPopup(e.pageX, e.pageY);
                    // Don't remove selection range - let user see their selection
                    return;
                }
                
                // For regular text selection - capture position using a more reliable method
                selectedText = selected;
                selectedTextPosition = getTextPosition(range, textDisplay);
                showSelectionPopup(e.pageX, e.pageY);
                selection.removeAllRanges();
            }
        }, 50);
    });
}

// Enhanced highlighting function with position-based entity support
function highlightEntities() {
    const textDisplay = document.getElementById('text-display');
    if (!textDisplay) return;
    
    // Get the original text before any highlighting
    let originalText = textDisplay.getAttribute('data-original-text') || textDisplay.textContent || textDisplay.innerText;
    
    // Decode HTML entities if present
    originalText = decodeHtmlEntities(originalText);
    
    // Store original text if not already stored
    if (!textDisplay.getAttribute('data-original-text')) {
        textDisplay.setAttribute('data-original-text', originalText);
    }
    

    
    let text = originalText;
    const allEntities = [];
    
    // Process entities and normalize to consistent format
    currentDrugs.forEach(drug => {
        if (typeof drug === 'string') {
            // Convert string entities to object format with position
            const positions = findAllOccurrences(text, drug);
            positions.forEach(pos => {
                allEntities.push({
                    text: drug,
                    type: 'drug',
                    start: pos.start,
                    end: pos.end
                });
            });
        } else if (drug.text && drug.position) {
            // Use position-based entity
            allEntities.push({
                text: drug.text,
                type: 'drug',
                start: drug.position.start,
                end: drug.position.end
            });
        }
    });
    
    currentEvents.forEach(event => {
        if (typeof event === 'string') {
            // Convert string entities to object format with position
            const positions = findAllOccurrences(text, event);
            positions.forEach(pos => {
                allEntities.push({
                    text: event,
                    type: 'adverse-event',
                    start: pos.start,
                    end: pos.end
                });
            });
        } else if (event.text && event.position) {
            // Use position-based entity
            allEntities.push({
                text: event.text,
                type: 'adverse-event',
                start: event.position.start,
                end: event.position.end
            });
        }
    });
    
    // Sort entities by start position (earliest first) and remove overlaps
    // Prioritize position-based entities over string-based ones
    allEntities.sort((a, b) => {
        if (a.start !== b.start) {
            return a.start - b.start;
        }
        // If same start position, prioritize position-based entities
        const aHasPosition = a.start !== undefined && a.end !== undefined;
        const bHasPosition = b.start !== undefined && b.end !== undefined;
        if (aHasPosition && !bHasPosition) return -1;
        if (!aHasPosition && bHasPosition) return 1;
        return 0;
    });
    const nonOverlappingEntities = removeOverlappingEntities(allEntities);
    

    
    // Apply highlighting from end to start to maintain positions
    nonOverlappingEntities.sort((a, b) => b.start - a.start);
    
    nonOverlappingEntities.forEach(entity => {
        const beforeText = text.substring(0, entity.start);
        const entityText = text.substring(entity.start, entity.end);
        const afterText = text.substring(entity.end);
        
        // Escape special characters in entity text for HTML attributes
        const escapedEntityText = entity.text.replace(/"/g, '&quot;');
        
        text = beforeText + 
               `<span class="highlight-${entity.type}" data-entity="${escapedEntityText}" data-start="${entity.start}" data-end="${entity.end}">${entityText}</span>` + 
               afterText;
    });
    
    textDisplay.innerHTML = text;
    
    // Get highlighted elements for click handlers
    const highlightedElements = textDisplay.querySelectorAll('.highlight-adverse-event, .highlight-drug');
    
    // Add click handlers and enable text selection within highlighted entities
    setTimeout(() => {
        highlightedElements.forEach(el => {
            if (!el) return;
            
            // Add click handler for the full entity
            el.addEventListener('click', function(event) {
                const entityText = this.getAttribute('data-entity');
                const entityType = this.classList.contains('highlight-drug') ? 'drug' : 'adverse-event';
                showEntityPopup(entityText, entityType, event);
            });
            
            // Enable text selection within highlighted entities
            el.style.userSelect = 'text';
            el.style.cursor = 'pointer';
            
            // Explicitly disable hover effects
            el.style.transition = 'none';
            el.addEventListener('mouseenter', function(e) {
                e.preventDefault();
                e.stopPropagation();
            });
            el.addEventListener('mouseover', function(e) {
                e.preventDefault();
                e.stopPropagation();
            });
        });
    }, 100);
}

// Find all occurrences of a text in the original text
function findAllOccurrences(text, searchText) {
    const positions = [];
    let startIndex = 0;
    
    // Handle edge cases
    if (!text || !searchText || text.trim() === '' || searchText.trim() === '') {
        return positions;
    }
    
    while (true) {
        const index = text.toLowerCase().indexOf(searchText.toLowerCase(), startIndex);
        if (index === -1) break;
        
        positions.push({
            start: index,
            end: index + searchText.length
        });
        
        startIndex = index + 1;
    }
    
    return positions;
}

// Remove overlapping entities, keeping the longer ones and prioritizing position-based entities
function removeOverlappingEntities(entities) {
    if (entities.length <= 1) return entities;
    
    const result = [];
    let current = entities[0];
    
    for (let i = 1; i < entities.length; i++) {
        const next = entities[i];
        
        // Check if entities overlap
        if (current.end > next.start) {
            // Overlap detected - prioritize position-based entities, then longer ones
            const currentHasPosition = current.start !== undefined && current.end !== undefined;
            const nextHasPosition = next.start !== undefined && next.end !== undefined;
            
            // If one has position and the other doesn't, keep the one with position
            if (currentHasPosition && !nextHasPosition) {
                // Keep current, skip next
                continue;
            } else if (!currentHasPosition && nextHasPosition) {
                // Replace current with next
                current = next;
                continue;
            }
            
            // If both have position or both don't, keep the longer one
            const currentLength = current.end - current.start;
            const nextLength = next.end - next.start;
            
            if (nextLength > currentLength) {
                current = next;
            }
        } else {
            // No overlap - add current to result and move to next
            result.push(current);
            current = next;
        }
    }
    
    // Add the last entity
    result.push(current);
    
    return result;
}

// Get the position of selected text in the original text
function getTextPosition(range, textDisplay) {
    let originalText = textDisplay.getAttribute('data-original-text') || textDisplay.textContent || textDisplay.innerText;
    originalText = decodeHtmlEntities(originalText);
    
    // Get the selected text
    const selectedText = range.toString();
    
    // Calculate the actual position by walking through the DOM
    let startOffset = 0;
    let found = false;
    
    // Create a range that covers the entire text display
    const fullRange = document.createRange();
    fullRange.selectNodeContents(textDisplay);
    
    // Create a range for the selection
    const selectionRange = range.cloneRange();
    
    // Compare the ranges to find the position
    if (selectionRange.compareBoundaryPoints(Range.START_TO_START, fullRange) >= 0) {
        // The selection starts after or at the beginning of the text display
        
        // Walk through all text nodes to find the exact position
        const walker = document.createTreeWalker(
            textDisplay,
            NodeFilter.SHOW_TEXT,
            null,
            false
        );
        
        let currentNode;
        while (currentNode = walker.nextNode()) {
            if (currentNode === range.startContainer) {
                startOffset += range.startOffset;
                found = true;
                break;
            }
            startOffset += currentNode.textContent.length;
        }
    }
    
    // If we couldn't find the position through DOM walking, use a fallback
    if (!found) {
        // Find all occurrences of the selected text
        const occurrences = [];
        let startIndex = 0;
        while (true) {
            const index = originalText.toLowerCase().indexOf(selectedText.toLowerCase(), startIndex);
            if (index === -1) break;
            occurrences.push(index);
            startIndex = index + 1;
        }
        
        if (occurrences.length === 0) {
            return {
                start: 0,
                end: selectedText.length,
                text: selectedText
            };
        }
        
        // If there's only one occurrence, use it
        if (occurrences.length === 1) {
            startOffset = occurrences[0];
        } else {
            // For multiple occurrences, use the first one for now
            // In a more sophisticated implementation, we could use mouse position or context
            startOffset = occurrences[0];
        }
    }
    
    return {
        start: startOffset,
        end: startOffset + selectedText.length,
        text: selectedText
    };
}

// Show selection popup
function showSelectionPopup(x, y) {
    // Hide entity popup if it's visible
    hideEntityPopup();
    
    const popup = document.getElementById('selection-popup');
    document.getElementById('selected-text').textContent = selectedText;
    
    popup.style.display = 'block';
    
    // Get popup dimensions
    const popupRect = popup.getBoundingClientRect();
    const popupWidth = popup.offsetWidth;
    const popupHeight = popup.offsetHeight;
    
    // Get viewport dimensions
    const viewportWidth = window.innerWidth;
    const viewportHeight = window.innerHeight;
    
    // Calculate initial position (centered horizontally, above the click)
    let left = x - (popupWidth / 2);
    let top = y - popupHeight - 15; // 15px margin above
    
    // Adjust horizontal position if popup would go off-screen
    if (left < 10) {
        left = 10; // Minimum 10px from left edge
    } else if (left + popupWidth > viewportWidth - 10) {
        left = viewportWidth - popupWidth - 10; // Minimum 10px from right edge
    }
    
    // Adjust vertical position if popup would go off-screen
    if (top < 10) {
        // If popup would go above viewport, show it below the click instead
        top = y + 15; // 15px margin below
    }
    
    // Ensure popup doesn't go below viewport
    if (top + popupHeight > viewportHeight - 10) {
        top = viewportHeight - popupHeight - 10;
    }
    
    popup.style.left = left + 'px';
    popup.style.top = top + 'px';
    popup.style.transform = 'none'; // Remove the default transform
}

// Hide selection popup
function hideSelectionPopup() {
    document.getElementById('selection-popup').style.display = 'none';
    selectedText = '';
}

// Show entity popup
function showEntityPopup(entityText, entityType, event) {
    event.stopPropagation();
    selectedEntity = entityText;
    
    // Hide selection popup if it's visible
    hideSelectionPopup();
    
    const popup = document.getElementById('entity-popup');
    const typeLabel = entityType === 'drug' ? 'Drug' : 'Adverse Event';
    
    document.getElementById('entity-type-label').textContent = typeLabel;
    document.getElementById('entity-text').textContent = entityText;
    
    popup.style.display = 'block';
    
    // Get popup dimensions
    const popupWidth = popup.offsetWidth;
    const popupHeight = popup.offsetHeight;
    
    // Get viewport dimensions
    const viewportWidth = window.innerWidth;
    const viewportHeight = window.innerHeight;
    
    // Calculate initial position (centered horizontally, above the click)
    let left = event.pageX - (popupWidth / 2);
    let top = event.pageY - popupHeight - 15; // 15px margin above
    
    // Adjust horizontal position if popup would go off-screen
    if (left < 10) {
        left = 10; // Minimum 10px from left edge
    } else if (left + popupWidth > viewportWidth - 10) {
        left = viewportWidth - popupWidth - 10; // Minimum 10px from right edge
    }
    
    // Adjust vertical position if popup would go off-screen
    if (top < 10) {
        // If popup would go above viewport, show it below the click instead
        top = event.pageY + 15; // 15px margin below
    }
    
    // Ensure popup doesn't go below viewport
    if (top + popupHeight > viewportHeight - 10) {
        top = viewportHeight - popupHeight - 10;
    }
    
    popup.style.left = left + 'px';
    popup.style.top = top + 'px';
    popup.style.transform = 'none'; // Remove the default transform
}

// Hide entity popup
function hideEntityPopup() {
    document.getElementById('entity-popup').style.display = 'none';
    selectedEntity = '';
}

// Add selected entity
function addSelectedEntity(type) {
    if (!selectedText) return;
    
    const currentList = type === 'drugs' ? currentDrugs : currentEvents;
    
    // Check if this exact text is already added (case-insensitive)
    const existingEntity = currentList.find(entity => {
        const entityText = typeof entity === 'string' ? entity : entity.text;
        return entityText.toLowerCase() === selectedText.toLowerCase();
    });
    
    if (existingEntity) {
        alert(`"${selectedText}" is already added.`);
        hideSelectionPopup();
        return;
    }
    
    // Store entity with position information if available
    const entityData = selectedTextPosition ? {
        text: selectedText,
        position: selectedTextPosition
    } : selectedText;
    
    currentList.push(entityData);
    updateEntityDisplay(type);
    highlightEntities();
    hideSelectionPopup();
    autoSave();
}

// Remove selected entity
function removeSelectedEntity() {
    // Find the entity to remove (case-insensitive)
    const drugIndex = currentDrugs.findIndex(entity => {
        const entityText = typeof entity === 'string' ? entity : entity.text;
        return entityText.toLowerCase() === selectedEntity.toLowerCase();
    });
    
    const eventIndex = currentEvents.findIndex(entity => {
        const entityText = typeof entity === 'string' ? entity : entity.text;
        return entityText.toLowerCase() === selectedEntity.toLowerCase();
    });
    
    if (drugIndex > -1) {
        currentDrugs.splice(drugIndex, 1);
        updateEntityDisplay('drugs');
    } else if (eventIndex > -1) {
        currentEvents.splice(eventIndex, 1);
        updateEntityDisplay('adverse_events');
    }
    
    highlightEntities();
    hideEntityPopup();
    autoSave();
}

// Add entity function
function addEntity(type) {
    const inputId = type === 'drugs' ? 'new-drug' : 'new-event';
    const input = document.getElementById(inputId);
    const entityName = input.value.trim();
    
    if (!entityName) return;
    
    const currentList = type === 'drugs' ? currentDrugs : currentEvents;
    
    // Check if entity already exists (case-insensitive)
    const existingEntity = currentList.find(entity => {
        const entityText = typeof entity === 'string' ? entity : entity.text;
        return entityText.toLowerCase() === entityName.toLowerCase();
    });
    
    if (existingEntity) {
        alert(`"${entityName}" is already added.`);
        return;
    }
    
    currentList.push(entityName);
    updateEntityDisplay(type);
    highlightEntities();
    autoSave();
    
    input.value = '';
    input.focus();
}

// Remove entity function
function removeEntity(type, entityName) {
    const currentList = type === 'drugs' ? currentDrugs : currentEvents;
    
    // Find the entity to remove (handle both string and object formats)
    const index = currentList.findIndex(entity => {
        const entityText = typeof entity === 'string' ? entity : entity.text;
        return entityText.toLowerCase() === entityName.toLowerCase();
    });
    
    if (index > -1) {
        currentList.splice(index, 1);
        updateEntityDisplay(type);
        highlightEntities();
        autoSave();
    }
}

// Update entity display
function updateEntityDisplay(type) {
    const containerId = type === 'drugs' ? 'current-drugs' : 'current-events';
    const countId = type === 'drugs' ? 'drug-count' : 'event-count';
    const container = document.getElementById(containerId);
    const currentList = type === 'drugs' ? currentDrugs : currentEvents;
    const tagClass = type === 'drugs' ? 'drug-tag' : 'adverse-event-tag';
    
    if (container) {
        if (currentList.length === 0) {
            const emptyState = type === 'drugs' 
                ? '<div class="empty-state-compact"><i class="fas fa-pills opacity-50"></i><span class="small">No drugs identified</span></div>'
                : '<div class="empty-state-compact"><i class="fas fa-exclamation-triangle opacity-50"></i><span class="small">No adverse events identified</span></div>';
            container.innerHTML = emptyState;
        } else {
            container.innerHTML = '';
            currentList.forEach(entity => {
                const tag = document.createElement('span');
                tag.className = `entity-tag-compact ${tagClass}`;
                
                // Handle both string and object formats
                const entityText = typeof entity === 'string' ? entity : entity.text;
                tag.innerHTML = `${entityText} <i class="fas fa-times"></i>`;
                tag.onclick = () => removeEntity(type, entityText);
                container.appendChild(tag);
            });
        }
    }
    
    const countElem = document.getElementById(countId);
    if (countElem) countElem.textContent = currentList.length;
}

// Handle enter key
function handleEnterKey(event, type) {
    if (event.key === 'Enter') {
        event.preventDefault();
        addEntity(type);
    }
}

// Auto-save functionality
let autoSaveTimeout;
function autoSave() {
    clearTimeout(autoSaveTimeout);
    autoSaveTimeout = setTimeout(() => {
        saveAnnotation(true);
    }, 1000);
}

// Save annotation
function saveAnnotation(silent = false, validated = false) {
    const annotationId = document.getElementById('text-display').getAttribute('data-annotation-id');
    
    // Convert entities to simple text arrays for saving
    const drugsText = currentDrugs.map(drug => {
        if (typeof drug === 'string') {
            return drug;
        } else if (drug.text) {
            return drug.text;
        }
        return '';
    }).filter(drug => drug);
    
    const eventsText = currentEvents.map(event => {
        if (typeof event === 'string') {
            return event;
        } else if (event.text) {
            return event.text;
        }
        return '';
    }).filter(event => event);
    
    const formData = new FormData();
    formData.append('drugs', drugsText.join(','));
    formData.append('adverse_events', eventsText.join(','));
    formData.append('is_validated', validated ? 'on' : '');
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    return fetch(`/annotation/${annotationId}/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && !silent) {
            if (validated) {
                const statusBadge = document.getElementById('status-badge');
                if (statusBadge) {
                    statusBadge.className = 'badge bg-success me-2';
                    statusBadge.innerHTML = '<i class="fas fa-check"></i> Validated';
                }
            }
        }
        return data;
    })
    .catch(error => {
        console.error('Error saving:', error);
        if (!silent) {
            alert('Error saving annotation');
        }
    });
}

// Validate and go to next
function validateAndNext() {
    const nextBtn = document.getElementById('next-btn');
    const originalText = nextBtn.innerHTML;
    
    nextBtn.innerHTML = '<i class="fas fa-spinner spinner"></i> Saving...';
    nextBtn.disabled = true;
    nextBtn.classList.add('loading');
    
    saveAnnotation(false, true).then(() => {
        setTimeout(() => {
            {% if next_annotation %}
                window.location.href = '{% url "annotation_single" next_annotation.id %}';
            {% endif %}
        }, 500);
    }).catch(() => {
        nextBtn.innerHTML = originalText;
        nextBtn.disabled = false;
        nextBtn.classList.remove('loading');
    });
}

// Validate current annotation
function validateCurrent() {
    const btn = document.querySelector('.btn-modern.btn-success');
    const originalText = btn.innerHTML;
    
    btn.innerHTML = '<i class="fas fa-spinner spinner"></i> Saving...';
    btn.disabled = true;
    btn.classList.add('loading');
    
    saveAnnotation(false, true).then(() => {
        btn.innerHTML = '<i class="fas fa-check"></i> Completed';
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
            btn.classList.remove('loading');
        }, 2000);
    }).catch(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
        btn.classList.remove('loading');
    });
}

// Hide popups when clicking outside
document.addEventListener('click', function(e) {
    if (!document.getElementById('selection-popup').contains(e.target)) {
        hideSelectionPopup();
    }
    if (!document.getElementById('entity-popup').contains(e.target)) {
        hideEntityPopup();
    }
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        const nextBtn = document.getElementById('next-btn');
        if (nextBtn) {
            validateAndNext();
        } else {
            validateCurrent();
        }
    }
    
    if ((e.ctrlKey || e.metaKey) && e.key === 'ArrowRight') {
        e.preventDefault();
        const nextBtn = document.getElementById('next-btn');
        if (nextBtn) {
            validateAndNext();
        }
    }
    
    if ((e.ctrlKey || e.metaKey) && e.key === 'ArrowLeft') {
        e.preventDefault();
        const prevBtn = document.querySelector('a.btn-modern.btn-outline-secondary');
        if (prevBtn) {
            prevBtn.click();
        }
    }
    
    if (e.key === 'Escape') {
        hideSelectionPopup();
        hideEntityPopup();
    }
});

function jumpToNoteInput() {
    const input = document.getElementById('note-jump-input');
    const value = parseInt(input.value, 10);
    if (!isNaN(value) && value >= 1 && value <= {{ total_count }}) {
        jumpToAnnotation(value);
    } else {
        input.classList.add('is-invalid');
        setTimeout(() => input.classList.remove('is-invalid'), 1200);
    }
}

// Google Search functionality
function setGoogleSearchInput(text) {
    const searchInput = document.getElementById('google-search-input');
    if (searchInput) {
        searchInput.value = text;
    }
}

function setupGoogleSearchSelection() {
    const textDisplay = document.getElementById('text-display');
    if (!textDisplay) return;
    
    textDisplay.addEventListener('mouseup', function(e) {
        setTimeout(() => {
            const selection = window.getSelection();
            const selected = selection.toString().trim();
            if (selected && selected.length > 0) {
                setGoogleSearchInput(selected);
            }
        }, 50);
    });
}

function searchGoogleSelectedText() {
    const selected = document.getElementById('selected-text').textContent.trim();
    if (selected) {
        const url = `https://www.google.com/search?q=${encodeURIComponent(selected + ' medical term')}`;
        window.open(url, '_blank');
    }
    hideSelectionPopup();
}

// Quick add entity from suggestions
function quickAddEntity(entityName, type) {
    const currentList = type === 'drug' ? currentDrugs : currentEvents;
    const entityType = type === 'drug' ? 'drugs' : 'adverse_events';
    
    // Check if entity already exists (case-insensitive)
    const existingEntity = currentList.find(entity => {
        const entityText = typeof entity === 'string' ? entity : entity.text;
        return entityText.toLowerCase() === entityName.toLowerCase();
    });
    
    if (existingEntity) {
        alert(`"${entityName}" is already added.`);
        return;
    }
    
    currentList.push(entityName);
    updateEntityDisplay(entityType);
    highlightEntities();
    autoSave();
}
</script>
{% endblock %} 